---
layout: post
title:  "TIL, 2017-05-17"
date:   2017-05-17 13:18:12 +0800
categories: programming
---

## Sourcepad Staging Server Setup

`[SP setup]` vs `[old setup]`

VPC/Virtual Private Cloud - Each Sourcepad project has a staging VPC and a production VPC. This is a set of virtual machines (which Amazon calls *instances*) which make up the project.

### VPC Components (Each of these are usually their own virtual machines)

| Component                                        | What Does It Do                                                                                                                                            | Comparison to Local Environment               | Privacy |
| -------------                                    | -------------                                                                                                                                              | -----                                         | ----    |
| Bastion                                          | This is the only machine that has shell access to the other machines                                                                                       | Iterm                                         | Private |
| Web Server/Nginx/Load Balancer                   | Routes `hello.sourcepadstage.com` to the correct app server. If more than one app server, the load balancer distributes requests to each of these servers. | Browser                                       | Private |
| App Server                                       | Runs the Rails app                                                                                                                                         | `localhost:3000`                              | Private |
| AWS Relational Database Service (RDS)            | Contains the relational database.                                                                                                                          | Your local RDBMS engine (PostgreSQL or MySQL) | Private |
| AWS ElastiCache (Optional)                       | Contains a key-value store (usually Redis). Redis is usually used for job queues like Resque and as a caching layer for your Rails app.                    | Your local Redis/`redis-server`.              | Private |
| AWS Route 53/DNS/Domain Naming System (Optional) | An alternative to other DNS providers like `namecheap.com` and `godaddy.com`.                                                                              | `ngrok`                                       | Public  |
|                                                  | You can choose to not set this up, but setting this up allows you to have one admin panel for both managing instances and managing DNS stuff. | | |
| AWS Simple Storage Service (S3)                  | Stores basically anything (photos, reports/PDFs, file uploads)                                                                                             | Your hard drive.                              | Private |
| NAT/Network Address Translation                  | Grants Internet access to the rest of the VPC.                                                                                                             | Your Wifi modem.                              | Public  |


#### Why We Split Each Role Up

Theoretically, all of this can be in one machine, but we do not put it in one machine, because:

- Multiple points of failure--we want to split things up so that even if things like the caching layer goes down, the web app can still function because the web app and RDS machine is still up.
- Can scale specific parts of the app--different machines have different requirements. Bastion doesn't need much, it literally is just a platform for deploying the apps, so we can leave it at a micro-level instance. A Rails server needs more CPU and an RDS server needs more memory (database accesses are memory intensive). If we need a faster Rails server, we do not need to scale the other components up.
- Continuing with different requirements for each machine, there are also different prices for each Amazon service.

#### On Bastion

- Even if you have your staging server's database username and password, you won't be able to access them from your local machine. Why is that? This is because your staging server's VPC only allows very few hosts to have shell access.
- These hosts are the Bastion server(s) (usually just one for staging). What you have to do to get shell access to the VPC is to SSH into the Bastion host, then inside the Bastion host, SSH *again* to which part of the VPC you need to access.
- How can Capistrano access those servers then? Well, your Capistrano settings do what I just mentioned for you (you still have to set this up. Check out `/config/deploy/staging.rb or config/deploy/production.rb`.

### Scaling Basics

2 primary ways to scale:

- **Vertical scaling**: Increasing the computing power of a machine (either CPU or memory). Most probably, you'll do this with RDS servers first.
- **Horizontal scaling**: Increasing the number of machines that do a specific role. Most probably, you'll do this with app servers first.

Example of a project that is vertically scaled: WF. WF needs a big database since it has millions of database rows. It is vertically scaled in the RDS layer (it is also horizontally scaled hehe).

Example of a project that is horizontally scaled: ?.

This is why it is better to have efficient code since efficient code is cheaper, computing wise. You don't need to scale immediately :).
